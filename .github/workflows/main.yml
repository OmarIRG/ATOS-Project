name: Deploy static site to S3 (OIDC)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}   # Ù„ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Actions

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  S3_PREFIX: ""

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}     # ğŸ‘ˆ Ù…Ù† Ø§Ù„Ù€ Secrets
          aws-region: ${{ env.AWS_REGION }}

      # Ù„Ùˆ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¨ÙŠØªØ¨Ù†ÙŠ (React / Angular / Vue ...)
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build

      - name: Sync to S3 (preserve structure)
        run: |
          SRC="."  # Ø£Ùˆ ØºÙŠÙ‘Ø±Ù‡Ø§ Ù„Ù…Ø¬Ù„Ø¯ build Ø£Ùˆ dist Ø­Ø³Ø¨ Ù…Ø´Ø±ÙˆØ¹Ùƒ
          BUCKET="${{ secrets.S3_BUCKET_NAME }}"   # ğŸ‘ˆ Ù…Ù† Ø§Ù„Ù€ Secrets

          if [ ! -d "$SRC" ]; then
            echo "âš ï¸ Folder $SRC not found. Set SRC to your site folder (e.g. ./build or .)."
            exit 1
          fi

          echo "ğŸš€ Deploying files from $SRC to s3://$BUCKET/$S3_PREFIX"

          aws s3 sync "$SRC" "s3://$BUCKET/$S3_PREFIX" \
            --delete \
            --exact-timestamps \
            --no-follow-symlinks \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "terraform/*" \
            --exclude ".gitignore"
