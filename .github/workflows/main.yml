name: Deploy static site to S3 (OIDC)

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  # لو عايز تنشر جوه مجلد (prefix) في البكت، حط القيمة هنا؛ وإلا سيبه فاضي
  S3_PREFIX: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}   # هنضيفه كـ Secret
          aws-region: ${{ env.AWS_REGION }}

      # لو محتاج Build (React/Angular/...), فك الكومنت وخلي SRC للمجلد الناتج
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build

      - name: Sync to S3 (preserve structure)
        run: |
          # لو موقع استاتيك جاهز في الجذر:
          SRC="."
          # لو عندك مخرجات Build حطها هنا (مثلاً ./dist أو ./build)
          # SRC="./dist"

          BUCKET="${{ secrets.S3_BUCKET_NAME }}"

          if [ ! -d "$SRC" ]; then
            echo "⚠️ Folder $SRC not found. Adjust SRC to the right path (e.g., ./build or .)."
            exit 1
          fi

          aws s3 sync "$SRC" "s3://$BUCKET/$S3_PREFIX" \
            --delete \
            --exact-timestamps \
            --no-follow-symlinks
